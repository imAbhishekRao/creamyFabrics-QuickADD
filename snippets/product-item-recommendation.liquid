{%- assign color_label_list = 'general.label.color' | t | replace: ', ', ',' | downcase | split: ',' -%}
{%- assign color_white_label = 'general.label.white' | t | downcase -%}
{%- assign quick_buy_icon_name = 'quick-buy-' | append: settings.cart_icon | replace: '_', '-' -%}

{%- if product.url contains '?' -%}
  {%- assign product_url_contains_query = true -%}
{%- else -%}
  {%- assign product_url_contains_query = false -%}
{%- endif -%}

<product-item
  class="product-item {% unless product.available %}product-item--sold-out{% endunless %}"
  {% if reveal %}
    reveal
  {% endif %}
>
  {%- capture product_labels -%}
    {%- for tag in product.tags -%}
      {%- if tag contains '__label' -%}
        <span class="label label--custom{% if tag contains '__label2' %}2{% endif %}">{{ tag | split: ':' | last }}</span>
      {%- endif -%}
    {%- endfor -%}

    {%- unless product.available -%}
      <span class="label label--subdued">{{ 'collection.product.sold_out' | t }}</span>
    {%- endunless -%}

    {%- assign cheapest_variant = product.variants | sort: 'price' | first -%}

    {%- if settings.show_discount and product.available and product.price < product.compare_at_price and cheapest_variant.compare_at_price != blank -%}
      {%- if settings.discount_mode == 'percentage' -%}
        {%- assign savings = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round | append: '%' -%}
      {%- else -%}
        {%- capture savings -%}{{ product.compare_at_price | minus: product.price | money }}{%- endcapture -%}
      {%- endif -%}

      <span class="label label--highlight">{{ 'collection.product.discount_html' | t: savings: savings }}</span>
    {%- endif -%}
  {%- endcapture -%}

  <div class="product-item__image-wrapper {% if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true %}product-item__image-wrapper--multiple{% endif %}">
    {%- if product_labels != blank and reduced_content != true -%}
      <div class="product-item__label-list label-list">
        {{- product_labels -}}
      </div>
    {%- endif -%}

    <a
      href="{{ product.url }}"
      data-instant
      class="product-item__aspect-ratio aspect-ratio {% if settings.product_image_size != 'natural' %}aspect-ratio--{{ settings.product_image_size }}{% endif %}"
      style="padding-bottom: {{ 100.0 | divided_by: product.featured_media.preview_image.aspect_ratio }}%; --aspect-ratio: {{ product.featured_media.preview_image.aspect_ratio }}"
    >
      {%- if product.featured_media -%}
        {{
          product.featured_media
          | image_url: width: product.featured_media.width
          | image_tag:
            loading: 'lazy',
            sizes: sizes_attribute,
            widths: '200,300,400,500,600,700,800,900,1000,1100,1200',
            class: 'product-item__primary-image',
            data-media-id: product.featured_media.id
        }}
      {%- endif -%}

      {%- if settings.product_color_display == 'swatch' -%}
        {%- for color_label in color_label_list -%}
          {% for option_name in product.options %}
            {% assign option_name_down = option_name | downcase %}
            {% if option_name_down contains color_label %}
              {% assign color_option_label = option_name %}
              {% break %}
            {% endif %}
          {% endfor %}
          {%- if product.options_by_name[color_option_label] != blank -%}
            {%- for color_option in product.options_by_name[color_option_label].values -%}
              {%- for variant in product.variants -%}
                {%- if variant.options contains color_option and variant.featured_media != blank -%}
                  {%- unless variant.featured_media == product.featured_media -%}
                    {{
                      variant.featured_media
                      | image_url: width: variant.featured_media.width
                      | image_tag:
                        loading: 'lazy',
                        sizes: sizes_attribute,
                        widths: '200,300,400,500,600,700,800,900,1000,1100,1200',
                        class: 'product-item__primary-image',
                        data-media-id: variant.featured_media.id,
                        hidden: true
                    }}
                    {% break %}
                  {%- endunless -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- if settings.show_secondary_image and product.media.size > 1 and hide_secondary_image != true -%}
        {%- assign next_media = product.media[product.featured_media.position] | default: product.media[1] -%}
        {{-
          next_media
          | image_url: width: next_media.width
          | image_tag:
            loading: 'lazy',
            sizes: sizes_attribute,
            widths: '200,300,400,500,600,700,800,900,1000,1100,1200',
            class: 'product-item__secondary-image'
        -}}
      {%- endif -%}
    </a>

    {%- comment -%} Quick Add Button for Recommendations {%- endcomment -%}
    {%- if request.page_type != 'password' and product.available and reduced_content != true and hide_secondary_image != true -%}
      <div class="product-item__quick-add-wrapper">
        {%- if product.variants.size == 1 -%}
          {%- capture form_id -%}product_form_recommendation_{{ section.id }}_{{ product.id }}_{% increment product_form_index %}{%- endcapture -%}
          {%- form 'product', product, is: 'product-form', id: form_id, class: 'product-item__quick-form' -%}
            <input type="hidden" name="quantity" value="1">
            <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
            <button
              is="loader-button"
              type="submit"
              class="button button--outline button--text button--full product-item__quick-add-button"
            >
              {{ 'collection.product.add_to_cart_short' | t }}
            </button>
          {%- endform -%}
        {%- else -%}
          <button
            is="toggle-button"
            loader
            aria-controls="product-recommendation-{{ section.id }}-{{ product.id }}-popover"
            aria-expanded="false"
            class="button button--outline button--text button--full product-item__quick-add-button"
          >
            {{ 'collection.product.quick_view' | t }}
          </button>

          <quick-buy-popover
            id="product-recommendation-{{ section.id }}-{{ product.id }}-popover"
            href="{{ product.url }}{% if product_url_contains_query %}&{% else %}?{% endif %}view=quick-buy-popover"
            class="popover popover--quick-buy"
          ></quick-buy-popover>
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>

  <div class="product-item__info {% if show_cta %}product-item__info--with-button{% endif %} {% if reduced_font_size %}text--small{% endif %}">
    {%- if product_labels != blank and reduced_content != true -%}
      <div class="product-item__label-list label-list CustomPosiitonBottom">
        {{- product_labels -}}
      </div>
    {%- endif -%}

    <div class="product-item-meta">
      {%- if settings.show_vendor -%}
        {%- assign vendor_handle = product.vendor | handle -%}
        {%- assign collection_for_vendor = collections[vendor_handle] -%}

        {%- unless collection_for_vendor.empty? -%}
          <a
            class="product-item-meta__vendor heading heading--xsmall"
            href="{{ collection_for_vendor.url }}"
            data-instant
          >
            {{- product.vendor -}}
          </a>
        {%- else -%}
          <a
            class="product-item-meta__vendor heading heading--xsmall"
            href="{{ product.vendor | url_for_vendor }}"
            data-instant
          >
            {{- product.vendor -}}
          </a>
        {%- endunless -%}
      {%- endif -%}

      {% liquid
        assign compared_product_title = product.title | split: '(#2)' | last | append: '(#2)'
        assign product_title = product.title
        if product.title == compared_product_title
          assign product_title = product_title | remove_last: '(#2)'
        endif
      %}
      <a href="{{ product.url }}" data-instant class="product-item-meta__title">{{ product_title }}</a>

      {% if product.metafields.custom.color_for_collection_pages != blank %}
        <span class="color--Metafeilds">
          {{ product.metafields.custom.color_for_collection_pages }}
        </span>
      {% endif %}

      <div 
        class="product-item-meta__price-list-container"
        data-datora-vid="{{ cheapest_variant.id }}"
        data-datora-pid="{{ product.id }}"
        data-datora-spgid="{{ cheapest_variant.selected_selling_plan_allocation.selling_plan_group_id }}"
        data-datora-tags="{{ product.tags }}"
        data-datora-price="{{ cheapest_variant.price }}"
      >
        <div class="price-list price-list--centered">
          {%- if product.price_varies and product.compare_at_price -%}
            {%- assign cheapest_variant = product.variants | sort: 'price' | first -%}

            {%- capture price_min -%}
              {%- if settings.currency_code_enabled -%}
                {{- cheapest_variant.price | money_with_currency -}}
              {%- else -%}
                {{- cheapest_variant.price | money -}}
              {%- endif -%}
            {%- endcapture -%}

            {%- if cheapest_variant.price < cheapest_variant.compare_at_price -%}
              <span class="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
              </span>

              <span class="price price--compare">
                <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
                {%- if settings.currency_code_enabled -%}
                  {{- cheapest_variant.compare_at_price | money_with_currency -}}
                {%- else -%}
                  {{- cheapest_variant.compare_at_price | money -}}
                {%- endif -%}
              </span>
            {%- else -%}
              <span class="price" data-datora-classes="price price--highlight">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                {{- 'collection.product.from_price_html' | t: price_min: price_min -}}
              </span>

              <span class="hidden" data-datora-classes="price price--compare">
                <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
                <span></span>
              </span>
            {%- endif -%}
          {%- elsif product.price < product.compare_at_price -%}
            <span class="price price--highlight">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            </span>

            <span class="price price--compare">
              <span class="visually-hidden">{{ 'product.general.regular_price' | t }}</span>
              {%- if settings.currency_code_enabled -%}
                {{- product.compare_at_price | money_with_currency -}}
              {%- else -%}
                {{- product.compare_at_price | money -}}
              {%- endif -%}
            </span>
          {%- elsif product.price_varies -%}
            {%- capture price_min -%}
              {%- if settings.currency_code_enabled -%}
                {{ product.price_min | money_with_currency }}
              {%- else -%}
                {{ product.price_min | money }}
              {%- endif -%}
            {%- endcapture -%}

            {%- capture price_max -%}
              {%- if settings.currency_code_enabled -%}
                {{- product.price_max | money_with_currency -}}
              {%- else -%}
                {{- product.price_max | money -}}
              {%- endif -%}
            {%- endcapture -%}

            <span class="price" data-datora-classes="price price--highlight">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {{- 'collection.product.from_price_html' | t: price_min: price_min, price_max: price_max -}}
            </span>

            <span class="hidden" data-datora-classes="price price--compare">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              <span></span>
            </span>
          {%- else -%}
            <span class="price" data-datora-classes="price price--highlight">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              {%- if settings.currency_code_enabled -%}
                {{- product.price | money_with_currency -}}
              {%- else -%}
                {{- product.price | money -}}
              {%- endif -%}
            </span>

            <span class="hidden" data-datora-classes="price price--compare">
              <span class="visually-hidden">{{ 'product.general.sale_price' | t }}</span>
              <span></span>
            </span>
          {%- endif -%}

          {%- if product.selected_or_first_available_variant.unit_price_measurement -%}
            <div class="price price--block text--xsmall text--subdued">
              <div class="unit-price-measurement">
                <span class="unit-price-measurement__price">
                  {{- product.selected_or_first_available_variant.unit_price | money -}}
                </span>
                <span class="unit-price-measurement__separator">/</span>

                {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                  <span class="unit-price-measurement__reference-value">
                    {{- product.selected_or_first_available_variant.unit_price_measurement.reference_value -}}
                  </span>
                {%- endif -%}

                <span class="unit-price-measurement__reference-unit">
                  {{- product.selected_or_first_available_variant.unit_price_measurement.reference_unit -}}
                </span>
              </div>
            </div>
          {%- endif -%}
        </div>
        <br />
        <li hidden class="datora discount-badge">
           {%- render 'icon' with 'discount-badge' -%}
           <span data-datora></span>
        </li>
      </div>

      {%- if settings.show_product_rating and reduced_content != true -%}
        <a class="product-item-meta__reviews-badge text--small" href="{{ product.url }}" data-instant>
          {%- render 'product-rating', product: product -%}
        </a>
      {%- endif -%}
      <div
        class="loox-rating"
        data-id="{{ product.id }}"
        data-rating="{{ product.metafields.loox.avg_rating }}"
        data-raters="{{ product.metafields.loox.num_reviews }}"
      ></div>
    </div>
  </div>
</product-item>

<style>
  .product-item__quick-add-wrapper {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    z-index: 2;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
  }

  .product-item:hover .product-item__quick-add-wrapper {
    opacity: 1;
    transform: translateY(0);
  }

  .product-item__quick-add-button {
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: #000;
    font-weight: 600;
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 8px;
    transition: all 0.2s ease;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 12px;
  }

  .product-item__quick-add-button:hover {
    background: rgba(255, 255, 255, 1);
    border-color: rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  .product-item__quick-add-button:active {
    transform: translateY(0);
  }

  .product-item__quick-add-button:focus {
    outline: 2px solid #000;
    outline-offset: 2px;
  }

  @media screen and (max-width: 740px) {
    .product-item__quick-add-wrapper {
      opacity: 1;
      transform: translateY(0);
    }
    
    .product-item__quick-add-button {
      font-size: 12px;
      padding: 6px 10px;
    }
  }

  @media screen and (max-width: 480px) {
    .product-item__quick-add-wrapper {
      bottom: 5px;
      left: 5px;
      right: 5px;
    }
    
    .product-item__quick-add-button {
      font-size: 11px;
      padding: 5px 8px;
    }
  }

  /* Ensure the product item has relative positioning for absolute positioning of quick add button */
  .product-item {
    position: relative;
  }

  .product-item__image-wrapper {
    position: relative;
  }
</style> 